%% Main Script for MaTH_CAMPS
% Runs everything with Euler timestepping
% Nicholas Knezek, mainly.
% Matt Weller, cool dude.
% March 2018

%% Added Melt and Migration

%%Todo
%       
%       add    Fix melt in lid temperature change
%               temperature dependant viscosity (be aware of 1e-16 rounding errors, will crop up in temp dep visc )
%%
clear all
pm = mantle.parameters(); % mantle parameters
pc = core.parameters(pm); % core parameters
n = pm.n;

%%
Myr = pm.Myr;

time_end = 4;   % [Myr] How long to run time series
dt_myr = 0.01; % [Myr] size of Euler timestep

Nt = round(time_end/dt_myr);
dt = dt_myr*Myr;
pc.dt = dt;
times = linspace(0,time_end*Myr,Nt);

Ntkeep_approx = 1000; % approx number of timesteps to keep
dtkeep = max(1,ceil(Nt/Ntkeep_approx));
Ntkeep = ceil(Nt/dtkeep);
%% Initial Temperatures

% starting temperatures of each layer
%Ta has time series of average temperature in each layer
Tm0 = [pm.Tliq(1), pm.Tliq(2), pm.Tsol(3)-250];
Tc0 = core.utils.adiabat(pm.Tsol(4)+25, pc);
T0 = [Tm0,Tc0];

%% Early melt processing for solid state convection 

% Calculate melt from initial conditions to set initial solid state
% temperature field for ODE solver
[f0,dTm0] = mantle.melt.melt_ini(Tm0,pm);
[dTli,flmi,flvi,Crti,fli] = mantle.melt.migration_ini(f0,Tm0(1),pm);   % calculates inital melting in lid
f0(1) = fli(1);    % induced melt from crystaliztion in lid

% Set initial temperatures to solidus approximation (solid state convection)
for x=1:pm.n
    Tm0(x) = Tm0(x)-dTm0(x);
end
T0(1:3) = Tm0;
%% Solve the system using Euler stepping
T = T0;
Tvec = zeros(Ntkeep,length(T0));
tvec = zeros(Ntkeep,1);
fvec = zeros(Ntkeep,pm.n);
i = 1;
for it=1:Nt
    dTdt = convectionODE(times(it),T',pm,pc);
    T = T + dTdt'*dt;
    % Melting processing
    % calculate change in temperature from melt and update Ta
    [f,dTm] = mantle.melt.melt(T(1:pm.n),pm);
    T(1:pm.n) = T(1:pm.n)-dTm;

    if mod(it,dtkeep) == 0
        Tvec(i,:) = T;
        tvec(i) = times(it);
        fvec(i) = f;
        i = i+1;
    end
    
end
Tm = Tvec(:,1:pm.n);
Tc = Tvec(:,pm.n+1:end);

%% Plot things to test
hold on
core.plot.temp_v_r(Tc(1,:),pc)
core.plot.temp_v_r(Tc(end,:),pc)
figure()
hold on
plot(tvec,Tm(:,1))
plot(tvec,Tm(:,2))
plot(tvec,Tm(:,3))
hold off


%% Postprocessing
mantle.post_processing(t,Ta,f,pm,pc)


%% Plot all things in plotting function
% Npl = 1000;
% plotting(t(1:Npl:end),Myr,Qu(1:Npl:end,:),n,Ht(1:Npl:end,:),A, ...
% Ta(1:Npl:end,:),flv(1:Npl:end,:),Tmat(1:Npl:end,:),Rmat(1:Npl:end,:), ...
% Ra(1:Npl:end,:),Crt(1:Npl:end,:),f(1:Npl:end,:),B(1:Npl:end,:),Tb(1:Npl:end,:))


%% Dynamo shutoff time based on termination heat output of ~ 1-2 Tw -- 20-60 mw/m^2
% core.utils.dynamo_timing(Qu)

